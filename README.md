# Epub Reader (é™çš„ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒª / PWA)

ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã§ EPUB ã¨ç”»åƒã‚¹ã‚­ãƒ£ãƒ³æ›¸ç±ï¼ˆCBZ/ZIPï¼‰ã‚’èª­ã‚ã‚‹è»½é‡ãªãƒªãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚Windows / Android / iPad / Quest 3 ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œã—ã€ã—ãŠã‚Šãƒ»ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ»å±¥æ­´ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚Firebase SDK ã§ã®ç›´æ¥é€šä¿¡ã¨ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã® Cloudflare Workers çµŒç”±é€šä¿¡ã«ã‚ˆã‚‹å†—é•·åŒ–ã•ã‚ŒãŸã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã‚’æä¾›ã—ã¾ã™ã€‚

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯é–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰ã¨è©¦è¡ŒéŒ¯èª¤ã‚’é‡è¦–ã—ã€**AI ã«ã‚ˆã‚‹ãƒã‚¤ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆvibe codingï¼‰**ã‚’ç©æ¥µçš„ã«å–ã‚Šå…¥ã‚Œã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

---

## ç‰¹å¾´

- ğŸ“š EPUB ã¨ç”»åƒã‚¹ã‚­ãƒ£ãƒ³(CBZ/ZIP)ã®ä¸¡å¯¾å¿œ
- ğŸ”– ã—ãŠã‚Š / ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ / å±¥æ­´ã®è‡ªå‹•ä¿å­˜
- ğŸ”„ å†—é•·åŒ–ã•ã‚ŒãŸã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ (Firebase SDK â†’ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Cloudflare Workers)
- ğŸ–¼ï¸ æŒ¿çµµãƒ»ç”»åƒã®ã‚¯ãƒªãƒƒã‚¯æ‹¡å¤§ã€ç”»åƒæ›¸ç±ã®ãƒšãƒ¼ã‚¸é€ã‚Š UI
- ğŸ“‘ ãƒ©ã‚¤ãƒ–ãƒ©ãƒª/å±¥æ­´ãƒ“ãƒ¥ãƒ¼ã¨é€²æ—è¡¨ç¤ºã€æœ€å¾Œã®ã—ãŠã‚Šã‹ã‚‰ã®å†é–‹
- ğŸ’¾ IndexedDB ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã€å†èª­ã¿è¾¼ã¿å¾Œã‚‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸è¦
- ğŸ“± PWA å¯¾å¿œï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åˆ©ç”¨å¯èƒ½ï¼‰

---

## å¯¾å¿œç’°å¢ƒ

- Windowsï¼šChrome / Edge
- Androidï¼šChrome
- iPadï¼šSafari / Chromeï¼ˆWebKitï¼‰
- Quest 3ï¼šãƒ–ãƒ©ã‚¦ã‚¶

â€»ã€Œã¾ãšãƒ–ãƒ©ã‚¦ã‚¶ã§ä½¿ãˆã‚‹ã“ã¨ã€ã‚’æœ€å„ªå…ˆã—ã€PWA ã¯ä¸Šä¹—ã›ã§æä¾›ã—ã¾ã™ã€‚

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser (Windows/Android/iPad)â”‚
â”‚  - Web App / PWA              â”‚
â”‚  - IndexedDB (library cache)  â”‚
â”‚  - Firebase SDK (å„ªå…ˆ)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€ â‘  å„ªå…ˆ: Firebase SDK (ç›´æ¥é€šä¿¡)
            â”‚   HTTPS
            â”‚   â–¼
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  â”‚ Firebase Database             â”‚
            â”‚  â”‚  - Firestore or Realtime DB   â”‚
            â”‚  â”‚  - bookmarks/history/settings â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â””â”€ â‘¡ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Cloudflare Workers çµŒç”±
                HTTPS
                â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Cloudflare Workers (API)      â”‚
               â”‚  - auth / validation / routingâ”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Firebase Database             â”‚
               â”‚  - Firestore or Realtime DB   â”‚
               â”‚  - bookmarks/history/settings â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

(é™çš„é…ä¿¡ã¯ Cloudflare Pages)
```

### é‹ç”¨å‰æ

- **ã‚½ãƒ¼ã‚¹ç®¡ç†**ï¼šGitHubï¼ˆæœ¬ãƒªãƒã‚¸ãƒˆãƒªï¼‰
- **ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°**ï¼šCloudflare Pagesï¼ˆé™çš„ã‚µã‚¤ãƒˆã¨ã—ã¦é…ä¿¡ï¼‰
- **åŒæœŸæ–¹å¼ï¼ˆå†—é•·åŒ–ï¼‰**ï¼š
  - **å„ªå…ˆ**: Firebase SDK ã«ã‚ˆã‚‹ç›´æ¥é€šä¿¡
  - **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: Cloudflare Workers çµŒç”±ã§ã®é€šä¿¡ï¼ˆSDK é€šä¿¡å¤±æ•—æ™‚ï¼‰
- **æ°¸ç¶šåŒ–**ï¼šFirebase Databaseï¼ˆFirestore ã¾ãŸã¯ Realtime Databaseï¼‰

---

## ä½¿ã„æ–¹

1. `index.html` ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã‹ã€Cloudflare Pages ãªã©ã§å…¬é–‹ã—ã¾ã™ã€‚
2. ã€ŒEPUB ã‚’é¸æŠã€ã¾ãŸã¯ã€Œç”»åƒã‚¹ã‚­ãƒ£ãƒ³æ›¸ç±ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€`.epub` ã‚‚ã—ãã¯ `.cbz/.zip` ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
3. èª­æ›¸ä¸­ã«ã€Œã“ã“ã«ã—ãŠã‚Šã‚’è¿½åŠ ã€ã§ä½ç½®ã‚’ä¿å­˜ã§ãã¾ã™ã€‚ã—ãŠã‚Šä¸€è¦§ã‚„å±¥æ­´ã‹ã‚‰å†é–‹å¯èƒ½ã§ã™ã€‚
4. ãƒ†ãƒ¼ãƒåˆ‡æ›¿ã‚„æ‹¡å¤§è¡¨ç¤ºãªã©ã¯ç”»é¢å³å´ã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ“ä½œã—ã¾ã™ã€‚

---

## RAR ä»£æ›¿æ‰‹æ®µã®è©•ä¾¡ã¨å¯¾å¿œæ–¹é‡

- è©³ç´°ã¯ `docs/rar-support.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ

### åŒæœŸæ–¹å¼ã®æ–¹é‡ï¼ˆå†—é•·åŒ–æ§‹æˆï¼‰

æœ¬ã‚¢ãƒ—ãƒªã¯ **Firebase SDK ã«ã‚ˆã‚‹ç›´æ¥é€šä¿¡ã‚’å„ªå…ˆ** ã—ã€SDK ã§ã®é€šä¿¡ã«å¤±æ•—ã—ãŸå ´åˆã« **è‡ªå‹•çš„ã« Cloudflare Workers çµŒç”±ã®é€šä¿¡ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯** ã™ã‚‹å†—é•·åŒ–æ§‹æˆã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

ã“ã®æ–¹å¼ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ï¼š

- **é€šå¸¸æ™‚ã®é«˜é€Ÿæ€§**: Firebase SDK ã«ã‚ˆã‚‹ç›´æ¥é€šä¿¡ã§ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’å®Ÿç¾
- **è€éšœå®³æ€§**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¶é™ã‚„åºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã§ SDK ãŒä½¿ãˆãªã„ç’°å¢ƒã§ã‚‚ Workers çµŒç”±ã§å‹•ä½œ
- **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§**: Firebase ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã‚„ä¸€æ™‚çš„ãªéšœå®³æ™‚ã‚‚ç¶™ç¶šåˆ©ç”¨å¯èƒ½

### åŒæœŸå¯¾è±¡

- ã—ãŠã‚Š / ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯
- å±¥æ­´
- é€²æ—
- UI è¨­å®šï¼ˆãƒ†ãƒ¼ãƒã€è¡¨ç¤ºãªã©ï¼‰

### è¨­å®šæ–¹æ³•

#### 1) Firebase SDK è¨­å®šï¼ˆå„ªå…ˆæ–¹å¼ï¼‰

ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã§ä»¥ä¸‹ã® Firebase è¨­å®šã‚’å…¥åŠ›ã—ã¾ã™ï¼š

```json
{
  "apiKey": "your-firebase-api-key",
  "authDomain": "your-app.firebaseapp.com",
  "projectId": "your-project-id",
  "storageBucket": "your-app.appspot.com",
  "messagingSenderId": "123456789",
  "appId": "your-app-id",
  "databaseURL": "https://your-app.firebaseio.com"
}
```

**æ³¨æ„**: Firestore ã‚’ä½¿ã†å ´åˆã¯ `databaseURL` ã¯ä¸è¦ã§ã™ã€‚Realtime Database ã‚’ä½¿ã†å ´åˆã¯å¿…è¦ã§ã™ã€‚

#### 2) Cloudflare Workers ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­å®šï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰

Firebase SDK ã§ã®é€šä¿¡ãŒå¤±æ•—ã—ãŸå ´åˆã«ä½¿ç”¨ã•ã‚Œã‚‹ Workers ã® URL ã‚’è¨­å®šã—ã¾ã™ï¼š

```
https://your-worker.your-subdomain.workers.dev
```

#### 3) åŒæœŸã®å®Ÿè¡Œ

1. è¨­å®šå®Œäº†å¾Œã€ã€Œä»Šã™ãã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã€ã‚’æŠ¼ã—ã¾ã™
2. ã‚¢ãƒ—ãƒªã¯ä»¥ä¸‹ã®é †åºã§é€šä¿¡ã‚’è©¦è¡Œã—ã¾ã™ï¼š
   - **Step 1**: Firebase SDK ã§ç›´æ¥é€šä¿¡ã‚’è©¦è¡Œ
   - **Step 2**: SDK ãŒå¤±æ•—ã—ãŸå ´åˆã€Workers çµŒç”±ã§é€šä¿¡
3. ã—ãŠã‚Š/å±¥æ­´/é€²æ—/è¨­å®šãŒ JSON å½¢å¼ã§ä¿å­˜ã•ã‚Œã¾ã™
4. åŒæœŸå®Œäº†å¾Œã€ä»–ã®ç«¯æœ«ã‹ã‚‰ã‚‚åŒã˜ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™

### é€šä¿¡ãƒ•ãƒ­ãƒ¼ã®è©³ç´°

```javascript
// ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰
async function syncToCloud(data) {
  try {
    // â‘  Firebase SDK ã§ç›´æ¥é€šä¿¡ã‚’è©¦è¡Œ
    await saveToFirebaseSDK(data);
    console.log('Firebase SDK ã§åŒæœŸæˆåŠŸ');
    return { success: true, method: 'sdk' };
  } catch (sdkError) {
    console.warn('Firebase SDK é€šä¿¡å¤±æ•—ã€Workers ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯', sdkError);
    
    try {
      // â‘¡ Workers çµŒç”±ã§é€šä¿¡
      await saveViaWorkers(data);
      console.log('Workers çµŒç”±ã§åŒæœŸæˆåŠŸ');
      return { success: true, method: 'workers' };
    } catch (workersError) {
      console.error('ã™ã¹ã¦ã®åŒæœŸæ–¹å¼ãŒå¤±æ•—', workersError);
      return { success: false, error: workersError };
    }
  }
}
```

### Firebase SDK å®Ÿè£…ã®è¦ä»¶

ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ã¯ Firebase JavaScript SDK (v9+ modular SDK) ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

```html
<!-- CDN çµŒç”±ã§èª­ã¿è¾¼ã¿ -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
  // ã¾ãŸã¯ Realtime Database
  import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
</script>
```

### Workers å®Ÿè£…ä¾‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰

Workers ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚Firebase Admin SDK ã‚’ä½¿ç”¨ã—ã¦ Firebase ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

```javascript
import { initializeApp, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

export default {
  async fetch(request, env) {
    // CORS å¯¾å¿œ
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type, Authorization',
        },
      });
    }

    try {
      // Firebase Admin SDK åˆæœŸåŒ–
      const app = initializeApp({
        credential: cert(JSON.parse(env.FIREBASE_SERVICE_ACCOUNT)),
      });
      const db = getFirestore(app);

      const { action, payload, userId } = await request.json();

      if (action === 'save') {
        // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        await db.collection('users').doc(userId).set(payload.data, { merge: true });
        return new Response(JSON.stringify({ ok: true }), {
          headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },
        });
      }

      if (action === 'load') {
        // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        const docSnap = await db.collection('users').doc(userId).get();
        const data = docSnap.exists ? docSnap.data() : null;
        return new Response(JSON.stringify({ data }), {
          headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },
        });
      }

      return new Response('Bad request', { status: 400 });
    } catch (error) {
      return new Response(JSON.stringify({ error: error.message }), {
        status: 500,
        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' },
      });
    }
  },
};
```

**ç’°å¢ƒå¤‰æ•°è¨­å®š**:
- `FIREBASE_SERVICE_ACCOUNT`: Firebase ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã® JSON ã‚­ãƒ¼

---

## âš ï¸ åŒæœŸæ©Ÿèƒ½ã«é–¢ã™ã‚‹æ³¨æ„ï¼ˆãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰

### å†—é•·åŒ–æ§‹æˆã«ã‚ˆã‚Šæ”¹å–„ã•ã‚Œã‚‹å•é¡Œ

æœ¬ã‚¢ãƒ—ãƒªã®å†—é•·åŒ–æ§‹æˆã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ãªç’°å¢ƒã§ã‚‚åŒæœŸãŒå‹•ä½œã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã¾ã‚Šã¾ã™ï¼š

- **åºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼æœ‰åŠ¹æ™‚**: Firebase SDK ãŒé®æ–­ã•ã‚Œã¦ã‚‚ Workers çµŒç”±ã§é€šä¿¡
- **ä¼æ¥­ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: Firebase SDK ãŒãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã§é®æ–­ã•ã‚Œã¦ã‚‚ Workers çµŒç”±ã§é€šä¿¡
- **ä¸€éƒ¨ã®ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒ**: SDK ã®åˆæœŸåŒ–ã«å¤±æ•—ã™ã‚‹ç’°å¢ƒã§ã‚‚ Workers ã§è£œå®Œ

### ãã‚Œã§ã‚‚åŒæœŸãŒå¤±æ•—ã™ã‚‹å ´åˆ

#### 1. åºƒå‘Šãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ã®ç¢ºèª

uBlock Origin, AdBlock, Privacy Badger ãªã©ãŒæœ‰åŠ¹ãªå ´åˆã€**ä¸¡æ–¹ã®é€šä¿¡çµŒè·¯ãŒé®æ–­ã•ã‚Œã‚‹å¯èƒ½æ€§**ãŒã‚ã‚Šã¾ã™ã€‚æœ¬ã‚¢ãƒ—ãƒªã®ãƒšãƒ¼ã‚¸ã«å¯¾ã—ã¦ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚

#### 2. Brave ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆ

ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®ãƒ©ã‚¤ã‚ªãƒ³ãƒãƒ¼ã‚¯ï¼ˆBrave Shieldsï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ã‚·ãƒ¼ãƒ«ãƒ‰ã‚’ **DOWNï¼ˆç„¡åŠ¹ï¼‰** ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚

#### 3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã®ç¢ºèª

ç¤¾å†…ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚„å­¦æ ¡ã® Wi-Fi ã§ã€Firebase ã¨ Workers ã®ä¸¡æ–¹ã¸ã®æ¥ç¶šãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

#### 4. é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã®ç¢ºèª

ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼ˆF12ï¼‰â†’ Console ã‚¿ãƒ–ã§ã€ã©ã¡ã‚‰ã®é€šä¿¡æ–¹å¼ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã§ãã¾ã™ï¼š

- `Firebase SDK ã§åŒæœŸæˆåŠŸ` â†’ SDK ã§ã®ç›´æ¥é€šä¿¡ãŒæˆåŠŸ
- `Firebase SDK é€šä¿¡å¤±æ•—ã€Workers ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯` â†’ Workers çµŒç”±ã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸ
- `ã™ã¹ã¦ã®åŒæœŸæ–¹å¼ãŒå¤±æ•—` â†’ ä¸¡æ–¹ã¨ã‚‚å¤±æ•—ï¼ˆè¨­å®šã‚„ç’°å¢ƒã‚’ç¢ºèªï¼‰

---

## åŒæœŸãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æµã‚Œ

- ã€Œè¨­å®šãƒ»é–²è¦§ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã™ã€ã§ JSON ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼ˆä»–ç«¯æœ«ã¸ã®æ‰‹å‹•ç§»è¡Œç”¨ï¼‰
- ã€Œè¨­å®šã‚’èª­ã¿è¾¼ã‚€ã€ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— JSON ã‚’æ¸¡ã™ã¨ã€ã—ãŠã‚Šã‚„å±¥æ­´ãŒå¾©å…ƒã•ã‚Œã¾ã™
- ãƒ•ã‚¡ã‚¤ãƒ«æœ¬ä½“ã¯ IndexedDB ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚åˆ¥ç«¯æœ«ã§é–‹ãå ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã§è¨­å®šã‚’å¾©å…ƒã—ã¦ãã ã•ã„

ç«¯æœ«ç§»è¡Œæ™‚ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã§å¾©å…ƒã—ã¾ã™ï¼š
- (A) ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆFirebase SDK â†’ Workers ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
- (B) JSON ã®æ‰‹å‹•ç§»è¡Œ

---

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆé–‹ç™ºè€…å‘ã‘ï¼‰

### 1) ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•

é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ãªã®ã§ã€ãƒ­ãƒ¼ã‚«ãƒ« HTTP ã‚µãƒ¼ãƒã§å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚

- Pythonï¼š`python -m http.server 8000`
- Node.jsï¼š`npx serve`

èµ·å‹•å¾Œï¼š`http://localhost:8000/` ã‚’é–‹ãã¾ã™ã€‚

### 2) Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

#### Firestore ã‚’ä½¿ã†å ´åˆ

1. Firebase Console ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
2. Firestore Database ã‚’æœ‰åŠ¹åŒ–
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šï¼š

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

4. ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’è¿½åŠ ã—ã¦ Firebase è¨­å®šã‚’å–å¾—
5. ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã« Firebase è¨­å®šã‚’å…¥åŠ›

#### Realtime Database ã‚’ä½¿ã†å ´åˆ

1. Firebase Console ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
2. Realtime Database ã‚’æœ‰åŠ¹åŒ–
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šï¼š

```json
{
  "rules": {
    "users": {
      "$userId": {
        ".read": "$userId === auth.uid",
        ".write": "$userId === auth.uid"
      }
    }
  }
}
```

4. ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚’è¿½åŠ ã—ã¦ Firebase è¨­å®šã‚’å–å¾—ï¼ˆ`databaseURL` ã‚‚å«ã‚€ï¼‰
5. ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã« Firebase è¨­å®šã‚’å…¥åŠ›

### 3) Cloudflare Pages ã¸ãƒ‡ãƒ—ãƒ­ã‚¤

- GitHub ãƒªãƒã‚¸ãƒˆãƒªã¨ Pages ã‚’é€£æºã—ã€`main` ã¸ã® push ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
- é™çš„ã‚µã‚¤ãƒˆã®ãŸã‚ã€åŸºæœ¬çš„ã«ãƒ“ãƒ«ãƒ‰å·¥ç¨‹ã¯ä¸è¦

### 4) Cloudflare Workers ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰

1. Workers ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆï¼š

```bash
npm create cloudflare@latest epub-reader-sync
cd epub-reader-sync
```

2. Firebase Admin SDK ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼š

```bash
npm install firebase-admin
```

3. ä¸Šè¨˜ã® Workers å®Ÿè£…ä¾‹ã‚’ã‚³ãƒ”ãƒ¼

4. Firebase ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’å–å¾—ï¼š
   - Firebase Console â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š â†’ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
   - ã€Œæ–°ã—ã„ç§˜å¯†éµã®ç”Ÿæˆã€ã§ã‚­ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

5. Workers ã®ç’°å¢ƒå¤‰æ•°ã«è¨­å®šï¼š

```bash
wrangler secret put FIREBASE_SERVICE_ACCOUNT
# JSON ã‚­ãƒ¼ã®å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘
```

6. ãƒ‡ãƒ—ãƒ­ã‚¤ï¼š

```bash
wrangler deploy
```

7. ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸ Workers ã® URL ã‚’ã‚¢ãƒ—ãƒªã®è¨­å®šã«è¿½åŠ 

---

## ãƒªãƒã‚¸ãƒˆãƒªæ§‹æˆï¼ˆç›®å®‰ï¼‰

- `index.html`ï¼šã‚¢ãƒ—ãƒªæœ¬ä½“
- `assets/`ï¼šJS/CSS/ç”»åƒãªã©
  - `assets/js/sync.js`ï¼šåŒæœŸãƒ­ã‚¸ãƒƒã‚¯ï¼ˆSDK â†’ Workers ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  - `assets/vendor/`ï¼š`jszip` / `unrar` ãªã©ã®è¿½åŠ ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
  - CDN çµŒç”±ã§ `epubjs` ã¨ Firebase SDK ã‚’èª­ã¿è¾¼ã¿
- `workers/`ï¼šCloudflare Workers ã®ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ APIï¼‰
- `dev.html` / `test.html`ï¼šé–‹ç™ºãƒ»æ¤œè¨¼ç”¨ï¼ˆå¿…è¦ãªã‚‰ `tools/` ã¸éš”é›¢ï¼‰

### ä¸è¦ã‚³ãƒ¼ãƒ‰/ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´ç†æ–¹é‡

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ŒAI ãƒã‚¤ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ç´ æ—©ãä½œã‚‹ã€æ€§æ ¼ä¸Šã€è©¦ä½œã®æ®‹éª¸ãŒæºœã¾ã‚Šã‚„ã™ã„å‰æã§ã™ã€‚ä»¥ä¸‹ã®åŸºæº–ã§æ•´ç†ã—ã¾ã™ã€‚

- **æœ¬ç•ªé…ä¿¡ã«ä¸è¦**ï¼š`dev.html` / `test.html` / `index.html.backup` ãªã©ã¯å‰Šé™¤ã¾ãŸã¯ `tools/` ã«ç§»å‹•
- **æ—§å®Ÿè£…ã®æ®‹éª¸**ï¼šWorkers ã®ã¿ã®å®Ÿè£…ã‚„ GAS å‰æã®ã‚³ãƒ¼ãƒ‰ã¯å‰Šé™¤
- **å®Ÿè£…ãŒäºŒé‡åŒ–ã—ã¦ã„ã‚‹**ï¼šåŒã˜è²¬å‹™ã®é–¢æ•°ãƒ»è¨­å®šãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯çµ±åˆ

---

## é–‹ç™ºãƒ¡ãƒ¢

- Firebase SDK ã¨ Workers ã®ä¸¡æ–¹ã«å¯¾å¿œã—ãŸåŒæœŸãƒ­ã‚¸ãƒƒã‚¯ã‚’ `assets/js/sync.js` ã«å®Ÿè£…
- Firebase SDK ã¯ CDN çµŒç”±ã§ modular SDK (v9+) ã‚’ä½¿ç”¨
- Workers ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦å®Ÿè£…ã—ã€Firebase Admin SDK ã§ Firebase ã«ã‚¢ã‚¯ã‚»ã‚¹
- è¿½åŠ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ `assets/vendor` ã¨ CDN çµŒç”±ã§ç®¡ç†ï¼ˆãƒ“ãƒ«ãƒ‰å·¥ç¨‹ä¸è¦ï¼‰

---

## Roadmapï¼ˆä¾‹ï¼‰

- âœ… Firebase SDK â†’ Workers ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å†—é•·åŒ–å®Ÿè£…
- PWA ã®å®‰å®šåŒ–ï¼ˆiPad/Safari ã®æŒ™å‹•å·®åˆ†å¸åï¼‰
- åŒæœŸã®è¡çªè§£æ±ºï¼ˆæœ€çµ‚æ›´æ–°ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ã€ãƒãƒ¼ã‚¸æ–¹é‡ï¼‰
- è¤‡æ•°ç«¯æœ«é–“ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸï¼ˆFirebase onSnapshot æ´»ç”¨ï¼‰
- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã®å¼·åŒ–ï¼ˆIndexedDB ã¨ã®åŒæœŸã‚­ãƒ¥ãƒ¼ï¼‰

---

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

æœ¬ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¦ä»¶ã«å¾“ã„è‡ªç”±ã«åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚
