<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Epub Reader</title>
    <link rel="stylesheet" href="./assets/style.css" />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚ˆã‚Šå‰ã«ã€åŒæœŸçš„ã«ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js" crossorigin="anonymous"></script>
    <!-- JSZipã¨ePubãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª -->
    <script>
      // EPUB.jsãŒå¿…è¦ã¨ã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ç¢ºå®Ÿã«è¨­å®š
      (function() {
        // JSZipã®ç¢ºèªã¨è¨­å®š
        if (typeof JSZip !== 'undefined') {
          window.JSZip = JSZip;
          console.log('[Init] JSZip loaded and set to window.JSZip');
        } else {
          console.error('[Init] JSZip NOT loaded from CDN!');
        }
        
        // ePubã®ç¢ºèªã¨è¨­å®š
        if (typeof ePub !== 'undefined') {
          window.ePub = ePub;
          console.log('[Init] ePub loaded and set to window.ePub');
        } else {
          console.error('[Init] ePub NOT loaded from CDN!');
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        console.log('[Init] Library status:', {
          JSZip: typeof JSZip !== 'undefined' ? 'loaded' : 'missing',
          'window.JSZip': typeof window.JSZip !== 'undefined' ? 'available' : 'missing',
          ePub: typeof ePub !== 'undefined' ? 'loaded' : 'missing',
          'window.ePub': typeof window.ePub !== 'undefined' ? 'available' : 'missing'
        });
      })();
    </script>
    <!-- èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œï¼‰ -->
    <script type="module">
      import { checkAuthStatus } from './assets/auth.js';
      
      // DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰èªè¨¼ãƒã‚§ãƒƒã‚¯
      window.addEventListener('DOMContentLoaded', () => {
        const authStatus = checkAuthStatus();
        
        if (!authStatus.authenticated) {
          console.log('Not authenticated, redirecting to login...');
          // é–‹ç™ºä¸­ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦èªè¨¼ãªã—ã§ãƒ†ã‚¹ãƒˆå¯èƒ½
          // window.location.href = '/login.html';
        } else {
          console.log('Authenticated as:', authStatus.userEmail);
        }
      });
    </script>
  </head>
  <body>
    <!-- å…¨ç”»é¢ãƒªãƒ¼ãƒ€ãƒ¼ -->
    <div id="fullscreenReader" class="fullscreen-reader">
      <!-- EPUB ãƒ“ãƒ¥ãƒ¼ã‚¢ -->
      <div id="viewer" class="viewer"></div>
      
      <!-- ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
      <div id="clickOverlay" class="click-overlay"></div>

      <!-- ç¸¦æ¨ªåˆ‡æ›¿ãƒœã‚¿ãƒ³ -->
      <div id="readerControls" class="reader-controls">
        <button id="toggleWritingMode" class="control-btn" type="button">æ¨ª</button>
        <button id="openToc" class="control-btn" type="button">ç›®æ¬¡</button>
      </div>
      
      <!-- ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ -->
      <div id="imageViewer" class="image-viewer hidden">
        <img id="pageImage" alt="ãƒšãƒ¼ã‚¸ç”»åƒ" />
      </div>
      
      <!-- ç©ºã®çŠ¶æ…‹ï¼ˆæœ¬ãŒæœªé¸æŠï¼‰ -->
      <div id="emptyState" class="empty-state">
        <div class="empty-icon">ğŸ“–</div>
        <h2>æœ¬ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</h2>
        <p>ç”»é¢å·¦ç«¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã€æœ¬ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      </div>
    </div>
    
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼ˆéè¡¨ç¤ºï¼‰ -->
    <input type="file" id="fileInput" accept=".epub,.cbz,.zip,.rar" class="file-input-hidden" />

    <!-- å·¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒƒã‚¯ãƒ‰ãƒ­ãƒƒãƒ— -->
    <div id="leftMenuBackdrop" class="menu-backdrop"></div>
    
    <!-- å·¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="leftMenu" class="left-menu">
      <div class="menu-header">
        <img src="assets/bookreader.png" alt="BookReader" class="menu-title-image" />
      </div>
      
      <nav class="menu-nav">
        <button id="menuOpen" class="menu-item">
          <span class="menu-icon">ğŸ“‚</span>
          <span>é–‹ã</span>
        </button>
        <button id="menuLibrary" class="menu-item">
          <span class="menu-icon">ğŸ“š</span>
          <span>ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</span>
        </button>
        <button id="menuSearch" class="menu-item">
          <span class="menu-icon">ğŸ”</span>
          <span>ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</span>
        </button>
        <button id="menuBookmarks" class="menu-item">
          <span class="menu-icon">ğŸ”–</span>
          <span>ã—ãŠã‚Š</span>
        </button>
        <button id="menuHistory" class="menu-item">
          <span class="menu-icon">ğŸ“œ</span>
          <span>å±¥æ­´</span>
        </button>
        <button id="menuSettings" class="menu-item">
          <span class="menu-icon">âš™ï¸</span>
          <span>è¨­å®š</span>
        </button>
        <button id="menuLogout" class="menu-item">
          <span class="menu-icon">ğŸšª</span>
          <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
        </button>
      </nav>

      <div class="menu-language">
        <button id="langJa" class="lang-btn" type="button">æ—¥</button>
        <button id="langEn" class="lang-btn" type="button">EN</button>
      </div>

      <div id="tocSection" class="toc-section hidden">
        <h3 class="toc-title">ç›®æ¬¡</h3>
        <ul id="tocList" class="toc-list"></ul>
      </div>
      
      <div class="menu-footer">
        <p id="userInfo" class="user-info"></p>
      </div>
    </div>

    <!-- é€²æ—ãƒãƒ¼ãƒãƒƒã‚¯ãƒ‰ãƒ­ãƒƒãƒ— -->
    <div id="progressBarBackdrop" class="menu-backdrop"></div>
    
    <!-- é€²æ—ãƒãƒ¼ãƒ‘ãƒãƒ« -->
    <div id="progressBarPanel" class="progress-bar-panel">
      <div class="progress-container">
        <div class="progress-track">
          <div id="progressFill" class="progress-fill"></div>
          <div id="progressThumb" class="progress-thumb"></div>
          <!-- ã—ãŠã‚Šãƒãƒ¼ã‚«ãƒ¼ã¯JSã§å‹•çš„ã«è¿½åŠ  -->
        </div>
        <div class="progress-info">
          <div class="page-numbers">
            <input 
              id="currentPageInput" 
              type="number" 
              class="current-page-input" 
              value="1" 
              min="1"
            />
            <span>/</span>
            <span id="totalPages" class="total-pages">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ã—ãŠã‚Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ -->
    <div id="bookmarkMenu" class="bookmark-menu">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="bookmarkMenuTitle">ã—ãŠã‚Š</h3>
          <button id="closeBookmarkMenu" class="close-btn">âœ•</button>
        </div>
        <div class="modal-body">
          <ul id="bookmarkList" class="bookmark-list"></ul>
          <button id="addBookmarkBtn" class="add-bookmark-btn">
            âœš ç¾åœ¨ä½ç½®ã«ã—ãŠã‚Šã‚’è¿½åŠ 
          </button>
        </div>
      </div>
    </div>

    <!-- ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆEPUBç”¨ï¼‰ -->
    <div id="searchModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h3 id="searchModalTitle">ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</h3>
          <button id="closeSearchModal" class="close-btn">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="search-input-container">
            <input 
              type="text" 
              id="searchInput" 
              class="search-input" 
              placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..." 
            />
            <button id="searchBtn" class="search-btn">ğŸ” æ¤œç´¢</button>
          </div>
          <div id="searchResults" class="search-results"></div>
        </div>
      </div>
    </div>

    <!-- ç›®æ¬¡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="tocModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h3 id="tocModalTitle">ç›®æ¬¡</h3>
          <button id="closeTocModal" class="close-btn">âœ•</button>
        </div>
        <div class="modal-body">
          <ul id="tocModalList" class="toc-list"></ul>
        </div>
      </div>
    </div>

    <!-- åŒæœŸãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="syncModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h3 id="syncModalTitle">åŒæœŸã®ç¢ºèª</h3>
        </div>
        <div class="modal-body">
          <p id="syncModalMessage" class="sync-message">ä»–ã®ç«¯æœ«ã§ã€ã‚ˆã‚Šæ–°ã—ã„èª­æ›¸ä½ç½®ãŒã‚ã‚Šã¾ã™ã€‚</p>
          <div class="sync-actions">
            <button id="syncUseRemote" class="sync-action-btn primary" type="button">ä»–ç«¯æœ«ã®ç¶šãã‹ã‚‰èª­ã‚€</button>
            <button id="syncUseLocal" class="sync-action-btn" type="button">ã“ã®ç«¯æœ«ã®ä½ç½®ã‹ã‚‰èª­ã‚€</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="openFileModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3 id="openFileModalTitle">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h3>
          <button id="closeFileModal" class="close-btn">âœ•</button>
        </div>
        <div class="modal-body">
          <div id="librarySection" class="library-section">
            <div class="library-controls">
              <h4 id="librarySectionTitle">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h4>
              <div class="library-view-toggle">
                <button id="libraryViewGrid" class="library-view-btn" type="button" aria-label="ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º">ğŸ”²</button>
                <button id="libraryViewList" class="library-view-btn" type="button" aria-label="ä¸€è¦§è¡¨ç¤º">ğŸ“„</button>
              </div>
            </div>
            <div id="libraryGrid" class="library-grid"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="historyModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h3 id="historyModalTitle">å±¥æ­´</h3>
          <button id="closeHistoryModal" class="close-btn">âœ•</button>
        </div>
        <div class="modal-body">
          <ul id="historyList" class="history-list"></ul>
        </div>
      </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settingsModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3 id="settingsModalTitle">è¨­å®š</h3>
          <button id="closeSettingsModal" class="close-btn">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="settings-section">
            <h4 id="settingsDisplayTitle">è¡¨ç¤ºè¨­å®š</h4>
            <div class="setting-item">
              <label for="themeSelect" id="themeLabel">ãƒ†ãƒ¼ãƒ</label>
              <select id="themeSelect">
                <option value="dark">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</option>
                <option value="light">ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰</option>
              </select>
            </div>
            <div class="setting-item">
              <label for="writingMode" id="writingModeLabel">æ›¸å­—æ–¹å‘</label>
              <select id="writingMode">
                <option value="horizontal">æ¨ªæ›¸ã</option>
                <option value="vertical">ç¸¦æ›¸ã</option>
              </select>
            </div>
            <div class="setting-item">
              <label for="pageDirection" id="pageDirectionLabel">é–‹ãæ–¹å‘</label>
              <select id="pageDirection">
                <option value="ltr">å·¦é–‹ã</option>
                <option value="rtl">å³é–‹ã</option>
              </select>
            </div>
            <div class="setting-item">
              <label for="progressDisplayMode" id="progressDisplayModeLabel">é€²æ—è¡¨ç¤ºå½¢å¼</label>
              <select id="progressDisplayMode">
                <option value="page">ãƒšãƒ¼ã‚¸æ•°</option>
                <option value="percentage">ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸</option>
              </select>
            </div>
          </div>
          
          <div class="settings-section">
            <h4 id="settingsCloudTitle">ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h4>
            <div class="setting-item">
              <label id="autoSyncLabel">
                <input type="checkbox" id="autoSyncEnabled" />
                Google Drive è‡ªå‹•åŒæœŸã‚’æœ‰åŠ¹ã«ã™ã‚‹
              </label>
            </div>
            <p class="setting-hint" id="autoSyncHint">â€» ã—ãŠã‚Šã€å±¥æ­´ã€é€²æ—ãŒ30ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</p>
          </div>
          
          <div class="settings-section">
            <h4 id="settingsDataTitle">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
            <div class="setting-actions">
              <button id="exportDataBtn" class="secondary-btn">è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã™</button>
              <label for="importDataInput" class="secondary-btn" id="importDataLabel">
                è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                <input type="file" id="importDataInput" accept="application/json" style="display:none;" />
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="imageModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <button id="closeImageModal" class="close-btn">âœ•</button>
        <img id="modalImage" alt="æ‹¡å¤§ç”»åƒ" />
      </div>
    </div>

    <script type="module" src="./assets/app.js"></script>
  </body>
</html>
