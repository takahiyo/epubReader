<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Epub Reader</title>
    <link rel="stylesheet" href="./assets/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
  </head>
  <body>
    <header class="top-bar">
      <div class="brand">
        <div class="logo">📖</div>
        <div>
          <h1>Epub Reader</h1>
          <p>EPUB と画像スキャン書籍を横断して読めるウェブアプリ</p>
        </div>
      </div>
      <div class="quick-actions">
        <button id="openBookmarkFromLibrary" class="secondary">しおりから開く</button>
        <button id="openSettings" class="secondary">設定・同期</button>
        <button id="syncNow" class="primary">今すぐクラウド同期</button>
      </div>
    </header>

    <main class="layout">
      <section class="left-column">
        <div class="card">
          <h2>本を開く</h2>
          <p class="hint">ローカル / Google Drive / OneDrive / pCloud から選べます。</p>
          <div class="actions">
            <button id="openFileModalButton" class="primary">開くダイアログを開く</button>
          </div>
          <p class="hint">「開く」専用モーダルでソース選択 → 認証 → ファイル選択の流れを案内します。</p>
        </div>

        <div class="card">
          <h2>ライブラリ</h2>
          <div id="libraryGrid" class="library-grid"></div>
        </div>

        <div class="card">
          <h2>履歴</h2>
          <ul id="historyList" class="list"></ul>
        </div>
      </section>

      <section class="reader-column">
        <div class="card reader-card">
          <div class="reader-header">
            <div>
              <h2 id="bookTitle">本が未選択です</h2>
              <p id="bookMeta" class="muted">EPUB / CBZ を読み込むとここに表示されます</p>
            </div>
            <div class="progress-group">
              <div id="progressText" class="muted">進捗 0%</div>
              <div class="progress">
                <div id="progressBar"></div>
              </div>
            </div>
          </div>

          <div id="viewer" class="viewer"></div>
          <div id="imageViewer" class="image-viewer hidden">
            <img id="pageImage" alt="ページ画像" />
            <div class="page-controls">
              <button id="prevPage">前へ</button>
              <span id="pageIndicator"></span>
              <button id="nextPage">次へ</button>
            </div>
          </div>

          <div class="reader-actions">
            <div class="action-group">
              <button id="bookmarkBtn" class="primary">ここにしおりを追加</button>
              <button id="goToBookmark" class="secondary">最後のしおりへ移動</button>
              <button id="toggleTheme" class="secondary">背景/文字色を切替</button>
            </div>
            <div class="action-group">
              <button id="prevSection">◀ 前の位置</button>
              <button id="nextSection">次の位置 ▶</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>しおり &amp; ブックマーク</h2>
          <ul id="bookmarkList" class="list"></ul>
        </div>
      </section>
    </main>

    <div id="imageModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <button id="closeModal" aria-label="閉じる">✕</button>
        <img id="modalImage" alt="拡大画像" />
      </div>
    </div>

    <div id="openFileModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3>ファイルを開く</h3>
          <button id="closeOpenFileModal" aria-label="閉じる">✕</button>
        </div>
        <div class="modal-body">
          <div class="source-switch">
            <label><input type="radio" name="openSource" value="local" checked /> ローカル</label>
            <label><input type="radio" name="openSource" value="drive" /> Google Drive</label>
            <label><input type="radio" name="openSource" value="onedrive" /> OneDrive</label>
            <label><input type="radio" name="openSource" value="pcloud" /> pCloud / URL</label>
          </div>

          <div id="openLocalSection">
            <p class="hint">ブラウザ上で処理されます。履歴やしおりはローカル保存され、同期設定を有効にするとクラウドにも保存されます。</p>
            <label class="file-input">
              <span>EPUB を選択 (.epub)</span>
              <input type="file" id="epubInput" accept=".epub" />
            </label>
            <label class="file-input">
              <span>画像スキャン書籍 (.cbz / .zip)</span>
              <input type="file" id="zipInput" accept=".cbz,.zip" />
            </label>
          </div>

          <div id="openDriveSection" class="hidden">
            <p class="hint">Drive の OAuth を完了した後、ファイル一覧を更新して選択します。</p>
            <div class="actions">
              <button id="openDriveAuth" class="secondary">Drive で認証する</button>
              <button id="refreshDriveFiles" class="secondary">Drive のファイルを一覧取得</button>
            </div>
            <div class="field">
              <label for="drivePickerSelect">Drive 上のファイル</label>
              <select id="drivePickerSelect"></select>
            </div>
            <div class="actions">
              <button id="openDriveSelected" class="primary">選択したファイルを開く</button>
            </div>
          </div>

          <div id="openOneDriveSection" class="hidden">
            <p class="hint">OneDrive の OAuth を完了した後、AppFolder(approot) 内の EPUB / ZIP を選択できます。</p>
            <div class="actions">
              <button id="openOneDriveAuth" class="secondary">OneDrive で認証する</button>
              <button id="refreshOneDriveFiles" class="secondary">OneDrive のファイルを一覧取得</button>
            </div>
            <div class="field">
              <label for="oneDrivePickerSelect">OneDrive AppFolder 内のファイル</label>
              <select id="oneDrivePickerSelect"></select>
            </div>
            <div class="actions">
              <button id="openOneDriveSelected" class="primary">選択したファイルを開く</button>
            </div>
          </div>

          <div id="openPCloudSection" class="hidden">
            <p class="hint">
              pCloud / カスタムエンドポイントは同期用に利用します。公開リンクやエンドポイント経由でファイルを直接開く場合は URL を入力してください（API
              Key が必要なら同期設定の値を利用します）。
            </p>
            <div class="field">
              <label for="pcloudFileUrlInput">pCloud / カスタム URL</label>
              <input id="pcloudFileUrlInput" type="url" placeholder="https://..." />
            </div>
            <div class="actions">
              <button id="openPcloudUrl" class="primary">URL から開く</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="settingsModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3>同期・設定</h3>
          <button id="closeSettingsModal" aria-label="閉じる">✕</button>
        </div>
        <div class="modal-body settings-grid">
          <div class="field">
            <label for="sourceSelect">同期に使うデータソース</label>
            <select id="sourceSelect">
              <option value="local">ローカルのみ</option>
              <option value="drive">Google Drive</option>
              <option value="onedrive">OneDrive</option>
              <option value="pcloud">pCloud / カスタムエンドポイント</option>
            </select>
          </div>
          <div class="field">
            <label for="endpointInput">pCloud / カスタム同期エンドポイント</label>
            <input id="endpointInput" type="url" placeholder="https://..." />
          </div>
          <div class="field">
            <label for="apiKeyInput">API Key / トークン (必要な場合)</label>
            <input id="apiKeyInput" type="text" />
          </div>
          <div class="field">
            <label for="driveClientIdInput">Google Drive クライアント ID (OAuth 用)</label>
            <input id="driveClientIdInput" type="text" placeholder="xxxxxxxx.apps.googleusercontent.com" />
          </div>
          <div class="field">
            <label for="driveFolderIdInput">同期保存先フォルダ ID (任意)</label>
            <input id="driveFolderIdInput" type="text" placeholder="Drive フォルダ ID" />
          </div>
          <div class="field">
            <label for="driveFileNameInput">同期用ファイル名</label>
            <input id="driveFileNameInput" type="text" placeholder="epub-reader-data.json" />
          </div>
          <div class="field">
            <label for="driveFileIdInput">既存の同期ファイル ID (任意)</label>
            <input id="driveFileIdInput" type="text" placeholder="既存の JSON ファイル ID" />
          </div>
          <div class="field">
            <label for="onedriveClientIdInput">OneDrive クライアント ID (OAuth 用)</label>
            <input id="onedriveClientIdInput" type="text" placeholder="アプリ登録のクライアント ID" />
          </div>
          <div class="field">
            <label for="onedriveFilePathInput">OneDrive 内の同期パス</label>
            <input id="onedriveFilePathInput" type="text" placeholder="epub-reader-data.json またはフォルダ/ファイル名" />
          </div>
          <div class="actions">
            <button id="sourceLogin" class="primary secondary">選択したソースでログイン / 接続</button>
            <button id="authorizeDrive" class="secondary">Google Drive と認証</button>
            <button id="authorizeOneDrive" class="secondary">OneDrive と認証</button>
          </div>
          <div id="syncStatus" class="status-box">
            <strong>同期状態</strong>
            <p id="syncStatusText" class="hint">利用するソースを選ぶと、ここに状態や次のアクションが表示されます。</p>
          </div>
          <div class="actions">
            <button id="exportData" class="secondary">設定・閲覧データを書き出す</button>
            <label for="importData" class="secondary file-label">設定を読み込む<input id="importData" type="file" accept="application/json" /></label>
          </div>
          <p class="hint">「今すぐクラウド同期」は画面右上から実行できます。クラウドに保存されるのはライブラリ/履歴/設定の JSON データです。</p>
        </div>
      </div>
    </div>

    <footer class="footer">
      <p>Windows / Android / iPad / Quest 3 ブラウザ対応。クラウド同期とローカル保存で安心して読書を続けられます。</p>
    </footer>

    <script type="module" src="./assets/app.js"></script>
  </body>
</html>
