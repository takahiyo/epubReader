<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Epub Reader</title>
    <link rel="stylesheet" href="./assets/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
    <!-- 認証チェック（ページ読み込み後に実行） -->
    <script type="module">
      import { checkAuthStatus } from './assets/auth.js';
      
      // DOMが読み込まれてから認証チェック
      window.addEventListener('DOMContentLoaded', () => {
        const authStatus = checkAuthStatus();
        
        if (!authStatus.authenticated) {
          console.log('Not authenticated, redirecting to login...');
          // 開発中はコメントアウトして認証なしでテスト可能
          // window.location.href = '/login.html';
        } else {
          console.log('Authenticated as:', authStatus.userEmail);
        }
      });
    </script>
  </head>
  <body>
    <!-- 全画面リーダー -->
    <div id="fullscreenReader" class="fullscreen-reader">
      <!-- EPUB ビューア -->
      <div id="viewer" class="viewer"></div>
      
      <!-- クリック検知用オーバーレイ -->
      <div id="clickOverlay" class="click-overlay"></div>
      
      <!-- 画像ビューア -->
      <div id="imageViewer" class="image-viewer hidden">
        <img id="pageImage" alt="ページ画像" />
      </div>
      
      <!-- 空の状態（本が未選択） -->
      <div id="emptyState" class="empty-state">
        <div class="empty-icon">📖</div>
        <h2>本が選択されていません</h2>
        <p>画面左端をクリックしてメニューを開き、本を選択してください</p>
      </div>
    </div>
    
    <!-- ファイル選択（非表示） -->
    <input type="file" id="fileInput" accept=".epub,.cbz,.zip,.rar" class="file-input-hidden" />

    <!-- 左サイドメニューバックドロップ -->
    <div id="leftMenuBackdrop" class="menu-backdrop"></div>
    
    <!-- 左サイドメニュー -->
    <div id="leftMenu" class="left-menu">
      <div class="menu-header">
        <div class="menu-logo">📖</div>
        <h2>Epub Reader</h2>
      </div>
      
      <nav class="menu-nav">
        <button id="menuOpen" class="menu-item">
          <span class="menu-icon">📂</span>
          <span>開く</span>
        </button>
        <button id="menuLibrary" class="menu-item">
          <span class="menu-icon">📚</span>
          <span>ライブラリ</span>
        </button>
        <button id="menuBookmarks" class="menu-item">
          <span class="menu-icon">🔖</span>
          <span>しおり</span>
        </button>
        <button id="menuHistory" class="menu-item">
          <span class="menu-icon">📜</span>
          <span>履歴</span>
        </button>
        <button id="menuSettings" class="menu-item">
          <span class="menu-icon">⚙️</span>
          <span>設定</span>
        </button>
        <button id="menuLogout" class="menu-item">
          <span class="menu-icon">🚪</span>
          <span>ログアウト</span>
        </button>
      </nav>
      
      <div class="menu-footer">
        <p id="userInfo" class="user-info"></p>
      </div>
    </div>

    <!-- 進捗バーバックドロップ -->
    <div id="progressBarBackdrop" class="menu-backdrop"></div>
    
    <!-- 進捗バーパネル -->
    <div id="progressBarPanel" class="progress-bar-panel">
      <div class="progress-container">
        <div class="progress-track">
          <div id="progressFill" class="progress-fill"></div>
          <div id="progressThumb" class="progress-thumb"></div>
          <!-- しおりマーカーはJSで動的に追加 -->
        </div>
        <div class="progress-info">
          <div class="page-numbers">
            <input 
              id="currentPageInput" 
              type="number" 
              class="current-page-input" 
              value="1" 
              min="1"
            />
            <span>/</span>
            <span id="totalPages" class="total-pages">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- しおりメニュー（モーダル） -->
    <div id="bookmarkMenu" class="bookmark-menu">
      <div class="modal-content">
        <div class="modal-header">
          <h3>しおり</h3>
          <button id="closeBookmarkMenu" class="close-btn">✕</button>
        </div>
        <div class="modal-body">
          <ul id="bookmarkList" class="bookmark-list"></ul>
          <button id="addBookmarkBtn" class="add-bookmark-btn">
            ✚ 現在位置にしおりを追加
          </button>
        </div>
      </div>
    </div>

    <!-- ファイル選択モーダル -->
    <div id="openFileModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3>ライブラリ</h3>
          <button id="closeFileModal" class="close-btn">✕</button>
        </div>
        <div class="modal-body">
          <div id="librarySection" class="library-section">
            <div class="library-controls">
              <h4>ライブラリ</h4>
              <div class="library-view-toggle">
                <button id="libraryViewGrid" class="library-view-btn" type="button" aria-label="グリッド表示">🔲</button>
                <button id="libraryViewList" class="library-view-btn" type="button" aria-label="一覧表示">📄</button>
              </div>
            </div>
            <div id="libraryGrid" class="library-grid"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 履歴モーダル -->
    <div id="historyModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h3>履歴</h3>
          <button id="closeHistoryModal" class="close-btn">✕</button>
        </div>
        <div class="modal-body">
          <ul id="historyList" class="history-list"></ul>
        </div>
      </div>
    </div>

    <!-- 設定モーダル -->
    <div id="settingsModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3>設定</h3>
          <button id="closeSettingsModal" class="close-btn">✕</button>
        </div>
        <div class="modal-body">
          <div class="settings-section">
            <h4>表示設定</h4>
            <div class="setting-item">
              <label for="themeSelect">テーマ</label>
              <select id="themeSelect">
                <option value="dark">ダークモード</option>
                <option value="light">ライトモード</option>
              </select>
            </div>
            <div class="setting-item">
              <label for="writingMode">書字方向</label>
              <select id="writingMode">
                <option value="horizontal">横書き</option>
                <option value="vertical">縦書き</option>
              </select>
            </div>
            <div class="setting-item">
              <label for="pageDirection">開き方向</label>
              <select id="pageDirection">
                <option value="ltr">左開き</option>
                <option value="rtl">右開き</option>
              </select>
            </div>
          </div>
          
          <div class="settings-section">
            <h4>クラウド同期</h4>
            <div class="setting-item">
              <label>
                <input type="checkbox" id="autoSyncEnabled" />
                Google Drive 自動同期を有効にする
              </label>
            </div>
            <p class="setting-hint">※ しおり、履歴、進捗が30秒ごとに自動保存されます</p>
          </div>
          
          <div class="settings-section">
            <h4>データ管理</h4>
            <div class="setting-actions">
              <button id="exportDataBtn" class="secondary-btn">設定・データを書き出す</button>
              <label for="importDataInput" class="secondary-btn">
                設定・データを読み込む
                <input type="file" id="importDataInput" accept="application/json" style="display:none;" />
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 画像拡大モーダル -->
    <div id="imageModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <button id="closeImageModal" class="close-btn">✕</button>
        <img id="modalImage" alt="拡大画像" />
      </div>
    </div>

    <script type="module" src="./assets/app.js"></script>
  </body>
</html>
