<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Epub Reader</title>
    <link rel="stylesheet" href="./assets/style.css" />
    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚ˆã‚Šå‰ã«ã€åŒæœŸçš„ã«ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js" crossorigin="anonymous"></script>
    <!-- JSZipã¨ePubãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª -->
    <script>
      // EPUB.jsãŒå¿…è¦ã¨ã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ç¢ºå®Ÿã«è¨­å®š
      (function() {
        // JSZipã®ç¢ºèªã¨è¨­å®š
        if (typeof JSZip !== 'undefined') {
          window.JSZip = JSZip;
          console.log('[Init] JSZip loaded and set to window.JSZip');
        } else {
          console.error('[Init] JSZip NOT loaded from CDN!');
        }
        
        // ePubã®ç¢ºèªã¨è¨­å®š
        if (typeof ePub !== 'undefined') {
          window.ePub = ePub;
          console.log('[Init] ePub loaded and set to window.ePub');
        } else {
          console.error('[Init] ePub NOT loaded from CDN!');
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        console.log('[Init] Library status:', {
          JSZip: typeof JSZip !== 'undefined' ? 'loaded' : 'missing',
          'window.JSZip': typeof window.JSZip !== 'undefined' ? 'available' : 'missing',
          ePub: typeof ePub !== 'undefined' ? 'loaded' : 'missing',
          'window.ePub': typeof window.ePub !== 'undefined' ? 'available' : 'missing'
        });
      })();
    </script>
    <!-- èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œï¼‰ -->
    <script type="module">
      import { checkAuthStatus } from './assets/auth.js';
      
      // DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰èªè¨¼ãƒã‚§ãƒƒã‚¯
      window.addEventListener('DOMContentLoaded', () => {
        const authStatus = checkAuthStatus();
        
        if (!authStatus.authenticated) {
          console.log('Not authenticated, redirecting to login...');
          // é–‹ç™ºä¸­ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦èªè¨¼ãªã—ã§ãƒ†ã‚¹ãƒˆå¯èƒ½
          // window.location.href = '/login.html';
        } else {
          console.log('Authenticated as:', authStatus.userEmail);
        }
      });
    </script>
  </head>
  <body>
    <!-- å…¨ç”»é¢ãƒªãƒ¼ãƒ€ãƒ¼ -->
    <div id="fullscreenReader" class="fullscreen-reader">
      <!-- EPUB ãƒ“ãƒ¥ãƒ¼ã‚¢ -->
      <div id="viewer" class="viewer"></div>
      
      <!-- ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
      <div id="clickOverlay" class="click-overlay"></div>
      
      <!-- ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ -->
      <div id="imageViewer" class="image-viewer hidden">
        <img id="pageImage" alt="ãƒšãƒ¼ã‚¸ç”»åƒ" />
      </div>
      
      <!-- ç©ºã®çŠ¶æ…‹ï¼ˆæœ¬ãŒæœªé¸æŠï¼‰ -->
    <div id="emptyState" class="empty-state">
      <div class="empty-icon">ğŸ“–</div>
      <h2 data-i18n="empty.title">æœ¬ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</h2>
      <p data-i18n="empty.description">ç”»é¢å·¦ç«¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã€æœ¬ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    </div>
    </div>
    
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼ˆéè¡¨ç¤ºï¼‰ -->
    <input type="file" id="fileInput" accept=".epub,.cbz,.zip,.rar" class="file-input-hidden" />

    <!-- å·¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒƒã‚¯ãƒ‰ãƒ­ãƒƒãƒ— -->
    <div id="leftMenuBackdrop" class="menu-backdrop"></div>
    
    <!-- å·¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="leftMenu" class="left-menu">
      <div class="menu-header">
        <img
          id="menuTitleImage"
          class="menu-title-image"
          src="./assets/bookreader.png"
          alt="Book Reader EPUB / ZIP / RAR"
        />
      </div>
      
      <nav class="menu-nav">
        <button id="menuOpen" class="menu-item">
          <span class="menu-icon">ğŸ“‚</span>
          <span data-i18n="menu.open">é–‹ã</span>
        </button>
        <button id="menuLibrary" class="menu-item">
          <span class="menu-icon">ğŸ“š</span>
          <span data-i18n="menu.library">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</span>
        </button>
        <button id="menuSearch" class="menu-item">
          <span class="menu-icon">ğŸ”</span>
          <span data-i18n="menu.search">ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</span>
        </button>
        <button id="menuBookmarks" class="menu-item">
          <span class="menu-icon">ğŸ”–</span>
          <span data-i18n="menu.bookmarks">ã—ãŠã‚Š</span>
        </button>
        <button id="menuHistory" class="menu-item">
          <span class="menu-icon">ğŸ“œ</span>
          <span data-i18n="menu.history">å±¥æ­´</span>
        </button>
        <button id="menuSettings" class="menu-item">
          <span class="menu-icon">âš™ï¸</span>
          <span data-i18n="menu.settings">è¨­å®š</span>
        </button>
        <button id="menuLogout" class="menu-item">
          <span class="menu-icon">ğŸšª</span>
          <span data-i18n="menu.logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
        </button>
        <div class="menu-language">
          <button
            id="langJa"
            class="lang-btn"
            type="button"
            data-lang="ja"
            data-i18n="language.ja"
            data-i18n-attr="aria-label"
            aria-label="æ—¥æœ¬èª"
          >
            ğŸ‡¯ğŸ‡µ
          </button>
          <button
            id="langEn"
            class="lang-btn"
            type="button"
            data-lang="en"
            data-i18n="language.en"
            data-i18n-attr="aria-label"
            aria-label="English"
          >
            ğŸ‡ºğŸ‡¸
          </button>
        </div>
      </nav>
      
      <div class="menu-footer">
        <p id="userInfo" class="user-info"></p>
      </div>
    </div>

    <!-- é€²æ—ãƒãƒ¼ãƒãƒƒã‚¯ãƒ‰ãƒ­ãƒƒãƒ— -->
    <div id="progressBarBackdrop" class="menu-backdrop"></div>
    
    <!-- é€²æ—ãƒãƒ¼ãƒ‘ãƒãƒ« -->
    <div id="progressBarPanel" class="progress-bar-panel">
      <div class="progress-container">
        <div class="progress-track">
          <div id="progressFill" class="progress-fill"></div>
          <div id="progressThumb" class="progress-thumb"></div>
          <!-- ã—ãŠã‚Šãƒãƒ¼ã‚«ãƒ¼ã¯JSã§å‹•çš„ã«è¿½åŠ  -->
        </div>
        <div class="progress-info">
          <div class="page-numbers">
            <input 
              id="currentPageInput" 
              type="number" 
              class="current-page-input" 
              value="1" 
              min="1"
            />
            <span>/</span>
            <span id="totalPages" class="total-pages">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ã—ãŠã‚Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ -->
    <div id="bookmarkMenu" class="bookmark-menu">
      <div class="modal-content">
        <div class="modal-header">
          <h3 data-i18n="bookmark.title">ã—ãŠã‚Š</h3>
          <button id="closeBookmarkMenu" class="close-btn">âœ•</button>
        </div>
        <div class="modal-body">
          <ul id="bookmarkList" class="bookmark-list"></ul>
          <button id="addBookmarkBtn" class="add-bookmark-btn">
            <span class="btn-icon">âœš</span>
            <span data-i18n="bookmark.add">ç¾åœ¨ä½ç½®ã«ã—ãŠã‚Šã‚’è¿½åŠ </span>
          </button>
        </div>
      </div>
    </div>

    <!-- ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆEPUBç”¨ï¼‰ -->
    <div id="searchModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h3 data-i18n="search.title">ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</h3>
          <button id="closeSearchModal" class="close-btn">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="search-input-container">
            <input 
              type="text" 
              id="searchInput" 
              class="search-input" 
              placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..."
              data-i18n="search.placeholder"
              data-i18n-attr="placeholder"
            />
            <button id="searchBtn" class="search-btn">
              <span class="btn-icon">ğŸ”</span>
              <span data-i18n="search.button">æ¤œç´¢</span>
            </button>
          </div>
          <div id="searchResults" class="search-results"></div>
        </div>
      </div>
    </div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="openFileModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3 data-i18n="library.title">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h3>
          <button id="closeFileModal" class="close-btn">âœ•</button>
        </div>
        <div class="modal-body">
          <div id="librarySection" class="library-section">
            <div class="library-controls">
              <h4 data-i18n="library.section">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h4>
              <div class="library-view-toggle">
                <button
                  id="libraryViewGrid"
                  class="library-view-btn"
                  type="button"
                  aria-label="ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º"
                  data-i18n="library.view.grid"
                  data-i18n-attr="aria-label"
                >
                  ğŸ”²
                </button>
                <button
                  id="libraryViewList"
                  class="library-view-btn"
                  type="button"
                  aria-label="ä¸€è¦§è¡¨ç¤º"
                  data-i18n="library.view.list"
                  data-i18n-attr="aria-label"
                >
                  ğŸ“„
                </button>
              </div>
            </div>
            <div id="libraryGrid" class="library-grid"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="historyModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h3 data-i18n="history.title">å±¥æ­´</h3>
          <button id="closeHistoryModal" class="close-btn">âœ•</button>
        </div>
        <div class="modal-body">
          <ul id="historyList" class="history-list"></ul>
        </div>
      </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settingsModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3 data-i18n="settings.title">è¨­å®š</h3>
          <button id="closeSettingsModal" class="close-btn">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="settings-section">
            <h4 data-i18n="settings.section.display">è¡¨ç¤ºè¨­å®š</h4>
            <div class="setting-item">
              <label for="themeSelect" data-i18n="settings.theme">ãƒ†ãƒ¼ãƒ</label>
              <select id="themeSelect">
                <option value="dark" data-i18n="settings.theme.dark">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</option>
                <option value="light" data-i18n="settings.theme.light">ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰</option>
              </select>
            </div>
            <div class="setting-item">
              <label for="writingMode" data-i18n="settings.writingMode">æ›¸å­—æ–¹å‘</label>
              <select id="writingMode">
                <option value="horizontal" data-i18n="settings.writingMode.horizontal">æ¨ªæ›¸ã</option>
                <option value="vertical" data-i18n="settings.writingMode.vertical">ç¸¦æ›¸ã</option>
              </select>
            </div>
            <div class="setting-item">
              <label for="pageDirection" data-i18n="settings.pageDirection">é–‹ãæ–¹å‘</label>
              <select id="pageDirection">
                <option value="ltr" data-i18n="settings.pageDirection.ltr">å·¦é–‹ã</option>
                <option value="rtl" data-i18n="settings.pageDirection.rtl">å³é–‹ã</option>
              </select>
            </div>
            <div class="setting-item">
              <label for="progressDisplayMode" data-i18n="settings.progressDisplayMode">é€²æ—è¡¨ç¤ºå½¢å¼</label>
              <select id="progressDisplayMode">
                <option value="page" data-i18n="settings.progressDisplayMode.page">ãƒšãƒ¼ã‚¸æ•°</option>
                <option value="percentage" data-i18n="settings.progressDisplayMode.percentage">ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸</option>
              </select>
            </div>
          </div>
          
          <div class="settings-section">
            <h4 data-i18n="settings.section.sync">ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h4>
            <div class="setting-item">
              <label for="saveDestination" data-i18n="settings.saveDestination">ä¿å­˜å…ˆ</label>
              <select id="saveDestination">
                <option value="local" data-i18n="settings.saveDestination.local">ãƒ­ãƒ¼ã‚«ãƒ«</option>
                <option value="drive" data-i18n="settings.saveDestination.drive">Google Drive</option>
                <option value="onedrive" data-i18n="settings.saveDestination.onedrive">OneDrive</option>
                <option value="pcloud" data-i18n="settings.saveDestination.pcloud">pCloud</option>
              </select>
              <p id="saveDestinationWarning" class="setting-hint setting-warning hidden" data-i18n="settings.saveDestination.warning">
                æœªãƒ­ã‚°ã‚¤ãƒ³ã®ã‚¯ãƒ©ã‚¦ãƒ‰å…ˆã¯é¸æŠã§ãã¾ã›ã‚“
              </p>
            </div>
            <div class="setting-item">
              <label>
                <input type="checkbox" id="autoSyncEnabled" />
                <span data-i18n="settings.autoSync">Google Drive è‡ªå‹•åŒæœŸã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
              </label>
            </div>
            <p class="setting-hint" data-i18n="settings.autoSyncHint">â€» ã—ãŠã‚Šã€å±¥æ­´ã€é€²æ—ãŒ30ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</p>
          </div>
          
          <div class="settings-section">
            <h4 data-i18n="settings.section.data">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
            <div class="setting-actions">
              <button id="exportDataBtn" class="secondary-btn" data-i18n="settings.exportData">è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã™</button>
              <label for="importDataInput" class="secondary-btn">
                <span data-i18n="settings.importData">è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</span>
                <input type="file" id="importDataInput" accept="application/json" style="display:none;" />
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="imageModal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <button id="closeImageModal" class="close-btn">âœ•</button>
        <img id="modalImage" alt="æ‹¡å¤§ç”»åƒ" />
      </div>
    </div>

    <script type="module" src="./assets/app.js"></script>
  </body>
</html>
